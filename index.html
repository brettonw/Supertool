<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supertool</title>
    <link rel="stylesheet" href="https://bedrock.brettonw.com/dist/latest/bedrock.css?0"/>
    <link rel="icon" type="image/png" href="icon.png?01"/>
</head>

<style>
    div[id="bedrock-database-container"] {
        display: inline-block;
        font-family: sans-serif;
        text-align: left;
        padding: 4px 0px;
        width: 100%;
    }

    div[id="bedrock-database-display"] {
        height: 500px;
        border: solid;
        border-width: 1px;
        border-radius: 2px;
        border-color: #bbb;
    }

    div[id="bedrock-record-display"] {
        margin-top: 5px;
        font-size: 12px;
    }

    body.noScroll {
        overflow: hidden;
    }

    body {
        max-width: 800px;
    }

    div[id="selected"] {
        margin: 5px;
    }

    .bedrock-paged-display-table-row {
        height: 130px;
        padding-bottom: 5px;
    }

    .bedrock-paged-display-table-row-entry {
    }

    .bedrock-paged-display-table-row-entry-text {
        vertical-align: middle;
        line-height: 120px;
    }

    .bedrock-paged-display-hover {
        color: white;
        background-color: #aaa;
    }

    .bedrock-combobox-paged-display-table-row {
        height: 19px;
    }

    .bedrock-combobox-paged-display-hover {
        color: white;
    }

    .title-display-box {
        text-align:left;
        height:100%;
        white-space:normal;
        line-height:20px;
        word-wrap:break-word;
        vertical-align: middle;
    }

    .par {
        font-size: 16px;
        font-family: Times, serif;
        margin: 12px 0;
    }
</style>

<body onload="main ();">

    <div style="text-align: center;"><a target="_blank" href="http://www.supertool.com"><img src="http://www.supertool.com/logo.jpg" /></a></div>

    <div class="par">If you have questions about what the Stanley numbers are, you can look the planes up on <a target="_blank" href="http://www.supertool.com/StanleyBG/stan0.htm">Blood&Gore (www.supertool.com/StanleyBG)</a>.</div>

    <div class="par">Sometimes, emails to/from me are vectored to some cyber black hole, never reaching their destination. I answer all emails, so if you haven't heard from me, your/my email is likely having high tea in said black hole, never to be heard from, so please try again.</div>

    <div class="par">If there is anything in particular that you're after, do ping me as there is a lot of stuff here that isn't on the list; the list just represents a snapshot of the previous month's haul with none of the stuff having appeared on a previous list. I like to keep things fresh here.</div>

    <div class="par">Please email me prior to sending money so that you can be sure the item is still up for grabs. Also, prices do not include shipping, which is the amount that it takes to go from me to you via the US Post Office.</div>

    <div class="par">This list goes out to many people, normally on the first Monday of the month (unless otherwise noted above). So, if you see something you want, it's the quickest finger on the trigger that wins the duel.</div>

    <div class="par">Some folks become upset that they miss out on a tool. I wish I had lots of this stuff many times over so I can satisfy the demand, but that is normally not the case. Some of it does have duplicates here, and if so, I will state that in my reply to you.</div>

    <div class="par">Also, due to the nature of selling over the wires, tools are sold on a first come, first serve basis. The first person to say "I'll take it", gets it. I have to operate this way as some will take a few days to get back to me with their interest in a particular item, and it's unfair to keep others waiting who are willing to buy the item immediately.</div>

    <div class="par">I reserve the right to correct typographical errors after the list goes out. I rarely make them, but when I do they can be major ones.</div>

    <div class="par">If you're the kind of person who puts a straightedge to the sole of a #40, to check it for flatness, or who tosses a plane on a scale to weigh it against what it states in the Stanley catalogs, you'll need to take your business elsewhere. I'll wish you luck finding perfection in something that was never made, nor intended to be, perfect. You guys know who you are, and it's best for both of us that our paths not cross.</div>

    <div class="par">Lastly, and I don't like to mention this, but if you tell me that money is on the way for something you want, and you never make good on it, we won't be doing business in the future. It's unfair, actually downright discourteous, to others who want the same thing, and I tell them it's sold. Pull this on me, and you're exorcised from the list. Sorry, but I don't tolerate this behavior well at all.</div>

    <div class="par">Don't forget the cool new tools that I'm making - a jazzy layout knife being used by professionals (made the cover of Feb.1998 FWW!), a detachable block plane handle designed to fit your standard pitch block planes, a killer Robinson's Improved Patent sliding bevel, a tilting jaw for your Emmert's vise, and the finest bench plane in production today, the Bed Rock #601. You can see it all at <a target="_blank" href="http://www.supertool.com/newtools.htm">www.supertool.com/newtools.htm</a>.</div>

    <div class="par">Remember, you don't have to be a connoisseur (did I spell that correctly) to shop here. You can be a wirehead, a metalhead, a zipper-head, a propellerhead, a deadhead, a cokehead, or even a knuckle dragging oaf, just like me, to shop here, as long as your dinero is green.</div>

    <div class="par">Thanks for shopping, and remember that no letters or words were injured when writing this list...</div>

    <div id="salesListSelectParent"></div>
    <hr style="margin:16px;">
    <div id="loading-div" style="display: none;">LOADING...</div>
    <div id="image-group-display" style="font-size: 12px;"></div>
    <div class="content-center footer">Built with <a target="_blank" class="footer-link" href="https://bedrock.brettonw.com">Bedrock</a><br>Repackaging software &copy; 2019-2020 Bretton Wade (see License and source on <a target="_blank" class="footer-link" href="https://github.com/brettonw/Supertool">Github</a>)<br>Supertool website and source data &copy; 1998-2020 Patrick Leach</div>
</body>
</html>

<script src="https://bedrock.brettonw.com/dist/latest/bedrock-debug.js?01"></script>
<script>
    "use strict";

    let months = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
    let lists = ["list", "llist"];

    /* http://www.supertool.com/forsale/2020mayllist.html */

    let main = function () {
        // the first one will automatically be selected...
        buildSalesListSelect ();
        selectSalesList ();
    };

    let formatMoney = function (amount) {
        const decimalCount = 2;
        const decimal = ".";
        const thousands = ",";

        let i = parseInt (amount = Math.abs (Number (amount) || 0).toFixed (decimalCount)).toString ();
        let j = (i.length > 3) ? i.length % 3 : 0;

        let dollars = (j ? i.substr (0, j) + thousands : '') + i.substr (j).replace (/(\d{3})(?=\d)/g, "$1" + thousands) + (decimalCount ? decimal + Math.abs (amount - i).toFixed (decimalCount).slice (2) : "");
        return "$" + ((amount < 0) ? "(" + dollars + ")" : dollars);
    };

    let getImageId = function (url) {
        let matches = url.match (/([^\/]*)\.jpg/i);
        if ((matches != null) && (matches.length > 1)) {
            //console.log ("Image Id = " + matches[1]);
            return matches[1];
        }
        return "UNKNOWN";
    };

    let ucFirst = function (string) {
        return string.charAt (0).toUpperCase () + string.slice (1);
    };

    let permuteList = function (input, output) {
        // a list of 3 items is a simple exercise, if we add more, this function will be a bit more interesting
        output.push (input[0] + input[1] + input[2]);
        output.push (input[0] + input[2] + input[1]);
        output.push (input[1] + input[0] + input[2]);
        output.push (input[1] + input[2] + input[0]);
        output.push (input[2] + input[0] + input[1]);
        output.push (input[2] + input[1] + input[0]);
    };

    let fallback = true;
    let findSalesList = function (monthIndex, year) {
        // set the LOADING... display
        let loadingDiv = document.getElementById ("loading-div");
        loadingDiv.innerHTML = "LOADING...";
        loadingDiv.style.display = "block";

        // basically, the names are some combination of (year + substring(month)) or (substring(month) + year)
        // we'll start with the straightforward one, and then start shortening the month name and alternating
        // year in front until we find something or run out of ideas
        let monthName = months[monthIndex];
        let length = monthName.length;
        console.log ("Finding sales list for " + ucFirst (monthName) + " " + year);

        // generate the list of names to try
        let tryNames = [];
        for (var list of lists) {
            for (var tryLength = 3; tryLength <= length; ++tryLength) {
                let tryName = monthName.substring (0, tryLength);
                permuteList([list, year, tryName], tryNames);
            }
        }

        // loop over the list until we are done trying - yes, it's recursive, but the call stack
        // depth shouldn't be but so bad...
        let tryNext = function (tryIndex) {
            if (tryIndex < tryNames.length) {
                let tryName = tryNames[tryIndex];
                let sourceUrl = "http://www.supertool.com/forsale/" + tryName + ".html";
                Bedrock.Http.get ("https://bedrock.brettonw.com/api?event=fetch&url=" + sourceUrl, function (tryResult) {
                    if (tryResult.status === "ok") {
                        console.log ("Found sales list for " + ucFirst (monthName) + " " + year + " at " + sourceUrl);
                        processSalesList (tryResult, monthName, year, sourceUrl);
                        document.getElementById ("salesListSelect").value = monthIndex + "/" + year;
                    } else {
                        tryNext (++tryIndex);
                    }
                });
            } else {
                let message = "Couldn't find sales list for " + ucFirst (monthName) + " " + year;
                console.log (message);
                loadingDiv.innerHTML = message;

                // in some cases, it might be into a given month but the new list has not been
                // released yet, so we want to fall back to last month's list... but only do this
                // one time to avoid deep recursion
                if (fallback === true) {
                    fallback = false;
                    if (--monthIndex < 0) {
                        monthIndex += 12;
                        --year;
                    }
                    findSalesList (monthIndex, year);
                }
            }
        };
        tryNext (0);
    };

    let buildSalesListSelect = function () {
        // get the current date
        let now = new Date ();
        let year = now.getFullYear ();
        let monthIndex = now.getMonth ();

        // always start with next month's list, so we show it as soon as it happens
        if (++monthIndex >= 12) {
            monthIndex -= 12;
            ++year;
        }

        // build the select
        let parent = document.getElementById("salesListSelectParent");
        let select = Bedrock.Html.Builder.begin ("select", { id: "salesListSelect", event: { change: selectSalesList } });
        for (let i = 0; i <= 12; ++i) {
            let monthName = months[monthIndex];
            select.begin ("option", { value: monthIndex + "/" + year, innerHTML: ucFirst (monthName) + " "  + year }).end ();
            if (--monthIndex < 0) {
                monthIndex += 12;
                --year;
            }
        }
        parent.appendChild(select.end ());
    };

    let selectSalesList = function () {
        let selectElement = document.getElementById ("salesListSelect");
        let selection = selectElement.options[selectElement.selectedIndex].value.split ("/");
        findSalesList (selection[0], selection[1]);
    };

    let processSalesList = function (queryResult, month, year, sourceUrl) {
        let target = document.getElementById ("image-group-display");
        // records is coming in as a JSON object with the text escaped. we first have to reconstruct the
        // original source code
        let content = queryResult.response.content
            .replace (/\\"/, "\"")
            .replace (/\\b/, "\b")
            .replace (/\\t/, "\t")
            .replace (/\\f/, "\f")
            .replace (/\\r/, "\r")
            .replace (/\\n/, "\n")
            .replace (/\\\\/, "\\")
        ;

        // then think about how to convert it into a database
        content = content
            .replace (/<br>/gi, "\n")
            .replace (/<meta [^>]+>/gi, "")
            .replace (/<span [^>]+><\/span>/gi, "")
            .replace (/<\/?pre>/gi, "")
            .replace (/&nbsp;/gi, " ")
            .replace (/&amp;/gi, "&")
            .replace (/\s+\n/g, "\n");
        content = content.substring (content.indexOf ("**\n") + 3);
        //console.log (content);

        // build a spider-like graph connecting the images and records
        let imageIndex = {};
        let addRecordToImage = function (record, imageUrl) {
            let imageId = getImageId (imageUrl);
            if (!(imageId in imageIndex)) {
                imageIndex[imageId] = {
                    id: imageId,
                    imageUrl: imageUrl,
                    recordIds: []
                }
            }
            imageIndex[imageId].recordIds.push (record.id);
            record.imageIds.push (imageId);
            //console.log ("Add record (" + record.id + ") to image (" + imageId + ") - " + imageIndex[imageId].recordIds.length + " links");
        };

        // loop over all the lines...
        let records = [];
        let recordIndex = {};
        let sumTotal = 0;
        let currentRecord = null;
        let indent;
        let lines = content.split (/\n/);
        for (let line of lines) {
            if (line.length > 0) {
                // if we don't have a current tool...
                if (currentRecord == null) {
                    // look for a tool code
                    let matches = line.match (/^\s\s[A-Z]+\d+/);
                    if ((matches != null) && (matches.length > 0)) {
                        // this starts the record
                        let id = matches[0].substring (2);

                        // the "body" of each description is indented. the "id" occupies
                        // at least 4 characters, padded with a space at the end. there
                        // are two spaces at the beginning of the line, and at least one
                        // more after that...
                        indent = Math.max (id.length, 4) + 3;
                        //console.log (id);
                        recordIndex[id] = currentRecord = {
                            id: id,
                            imageIds: [],
                            title: "",
                            description: "",
                            price: 0,
                            maker: "",
                            condition: ""
                        };
                    }
                }

                // these are only valid if we are in a record...
                if (currentRecord != null) {
                    // look for description
                    let description = line.substring (indent);
                    if (description.charAt (0) !== ' ') {
                        currentRecord.description += description + " ";
                    }

                    // look for a link
                    let matches = line.match (/<a href="(http:.*\.jpg)"/);
                    if ((matches != null) && (matches.length > 1)) {
                        let imageUrl = matches[1];
                        addRecordToImage (currentRecord, imageUrl);
                    }

                    // look for a price
                    matches = line.match (/\$(\d+\.\d\d)\s*$/);
                    if ((matches != null) && (matches.length > 1)) {
                        currentRecord.price = matches[1];
                        sumTotal += parseFloat(currentRecord.price);

                        // de-hyphenate where the original text was wrapped
                        currentRecord.description = currentRecord.description.replace (/([^-])- /, "$1");

                        // get the title from the beginning of the description
                        let semicolon = currentRecord.description.indexOf (";");
                        if (semicolon > 0) {
                            currentRecord.title = ucFirst (currentRecord.description.substring (0, semicolon));
                            currentRecord.description = currentRecord.description.substring (semicolon + 1).trim ();
                        } else {
                            currentRecord.title = "UNTITLED";
                        }

                        // try to find the maker, Stanley is obvious
                        if (currentRecord.id.match (/^ST\d+$/)) {
                            currentRecord.maker = "Stanley";
                            let hashIndex = currentRecord.title.indexOf ("#");
                            if (hashIndex >= 0) {
                                currentRecord.title = currentRecord.title.replace ("#", currentRecord.maker + " #");
                            } else {
                                currentRecord.title = currentRecord.maker + " - " + currentRecord.title;
                            }
                        } else {
                            // is it in the title?
                        }

                        // try to find the picture location
                        let locMatches = currentRecord.description.match (/;\s*([^;]+):/);
                        if ((locMatches != null) && (locMatches.length > 1)) {
                            let position = locMatches[1].toLowerCase ();
                            let wordCount = position.split (" ").length;
                            if (wordCount < 5) {
                                if (position.includes ("top") || position.includes ("bottom") || position.includes ("left") || position.includes ("right") || position.includes ("middle")) {
                                    //console.log ("POSITION: " + locMatches[1]);
                                    currentRecord.position = position;

                                    // and strip the position off the end of the description
                                    currentRecord.description = currentRecord.description.replace (/;\s*[^;]+:/, "");
                                } else {
                                    //console.log ("NO POSITION FOUND (missing keywords): " + position);
                                }
                            } else {
                                //console.log ("NO POSITION FOUND (length): " + position);
                            }
                        }

                        // if we got all this way and there is no position in the record, strip the
                        // colon at the end of the description
                        if (!("position" in currentRecord)) {
                            currentRecord.description = currentRecord.description.replace (/:\s*$/, "");
                        }

                        // this finishes the record
                        records.push (currentRecord);
                        currentRecord = null;
                    }
                }

            }
        }

        console.log ("Found " + records.length + " tools for sale, totalling " + formatMoney(sumTotal) + " (Average price per tool is " + formatMoney (sumTotal / records.length) + ")");

        // recursive graph traversal functions
        let touchedRecordIds = {};
        let touchedImageIds = {};
        let collectImageIdsFromRecordId = function (recordId, recordIds, imageIds) {
            if (!(recordId in touchedRecordIds)) {
                //console.log ("Checking Record Id: " + recordId);
                let record = recordIds[recordId] = touchedRecordIds[recordId] = recordIndex[recordId];

                // loop over all of the imageIds in that record
                for (let imageId of record.imageIds) {
                    collectRecordIdsFromImageId (imageId, recordIds, imageIds);
                }
            }
            return Object.keys (imageIds).length;
        };

        let collectRecordIdsFromImageId = function (imageId, recordIds, imageIds) {
            if (!(imageId in touchedImageIds)) {
                //console.log ("Checking Image Id: " + imageId);
                let image = imageIds[imageId] = touchedImageIds[imageId] = imageIndex[imageId];

                // get all the records associated with this image
                for (let recordId of image.recordIds) {
                    collectImageIdsFromRecordId (recordId, recordIds, imageIds);
                }
            }
        };

        // set the target
        console.log ("Setting target");
        while (target.lastElementChild) {
            target.removeChild (target.lastElementChild);
        }

        // add a title line with the name of the list, and a link to the original page
        target.appendChild (Bedrock.Html.Builder.begin ("h2").begin ("a", { href: sourceUrl, target: "_blank", style: { textDecoration: "none" }, title: "View original source", innerHTML: ucFirst (month) + " " + year }).end ().end ());

        // build the image group displays by walking over the records in their natural order
        for (let record of records) {
            // start by walking the graph to get all the images and records that will be part of this cluster
            let recordIds = {};
            let imageIds = {};
            if (collectImageIdsFromRecordId (record.id, recordIds, imageIds) > 0) {
                let cluster = Bedrock.Html.Builder.begin ("div", { style: { margin: "5px 0", padding: "8px", borderWidth: "1px", borderColor: "gray", borderStyle: "solid" } });
                //console.log ("CLUSTER");

                // emit all the images for this cluster
                let clusterImages = cluster.begin ("div", { style: { verticalAlign: "middle", textAlign: "center" } });
                for (let imageId of Object.keys (imageIds).sort ()) {
                    //console.log ("  Image Id: " + imageId);
                    let image = imageIndex[imageId];
                    clusterImages
                        .begin ("a", { href: image.imageUrl, target: "_blank" })
                        .begin ("img", { src: image.imageUrl, style: { borderWidth: "1px", borderStyle: "solid", borderColor: "blue", maxHeight: "140px", maxWidth: "500px", height: "auto", width: "auto", margin: "0 5px 0 0" } }).end ()
                        .end ();
                }
                clusterImages.end ();

                // emit all the records from this cluster
                let clusterRecords = cluster.begin ("div").begin ("table");
                for (let recordId of Object.keys (recordIds).sort ()) {
                    //console.log ("  Record Id: " + recordId);
                    let displayRecord = recordIndex[recordId];

                    // make bullets of the description
                    let bullets = displayRecord.description.split (";");
                    let description = "<ul>";
                    for (let bullet of bullets) {
                        bullet = bullet.trim ();
                        description += "<li>" + ucFirst (bullet) + "</li>";
                    }
                    description += "<ul>";

                    clusterRecords
                        .begin ("tr", { style: { height: "12px" } }).end ()
                        .begin ("tr", { style: { verticalAlign: "top" } })
                        .begin ("td", { style: { width: "50px" }, innerHTML: recordId }).end ()
                        .begin ("td", { style: { width: "65px" }, innerHTML: formatMoney (displayRecord.price) }).end ()
                        .begin ("td", { style: { width: "550px" } })
                        .begin ("div", { innerHTML: displayRecord.title, style: { fontWeight: "bold" } }).end ()
                        .begin ("div", { innerHTML: description }).end ()
                        .end ()
                        .begin ("td", { style: { width: "100px", fontSize: "10px", fontStyle: "italic", textAlign: "right" }, innerHTML: ("position" in displayRecord) ? displayRecord.position : "" }).end ()
                        .end ();
                }
                clusterRecords.end ().end ();

                // incrementally add the cluster, so te user doesn't feel like the page takes a long time to load
                target.appendChild (cluster.end ());
            }
        }

        // finish up, turn off the "loading" text, and show the top of the list
        console.log ("Finished");
        document.getElementById ("loading-div").style.display = "none";
        target.scrollIntoView ();
    };
</script>
